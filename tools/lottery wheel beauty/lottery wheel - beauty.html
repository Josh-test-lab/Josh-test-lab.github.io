<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <style>
      body {
        font-family: 'Arial', sans-serif;
        background-color: #a6a7a8;
        padding: 20px;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        justify-content: flex-start;
        gap: 20px;
      }

      h1 {
        font-size: 2rem;
        color: #333;
        margin-bottom: 20px;
      }

      .container {
        display: flex;
        justify-content: space-between;
        width: 100%;
        max-width: 1200px;
        gap: 20px;
        margin-top: 30px;
      }

      .history-container, .lottery-container, .settings-container {
        flex: 1;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .lottery-box {
        width: 100%;
        max-width: 350px;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 45px;
        font-weight: bold;
        background: linear-gradient(135deg, #fa9577, #f7a3d4);
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s ease;
      }

      textarea {
        width: 100%;
        max-width: 500px;
        height: 200px;
        font-size: 16px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        resize: none;
        transition: border-color 0.3s ease;
      }

      textarea:focus {
        border-color: #ff8c00;
        outline: none;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #ff8c00;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
      }

      button:hover {
        background-color: #e07b00;
        transform: translateY(-2px);
      }

      button:disabled {
        background-color: #ddd;
        cursor: not-allowed;
      }

      ul {
        list-style-type: none;
        padding: 0;
        width: 100%;
        max-width: 500px;
        margin: 0;
      }

      li {
        background: #f1f1f1;
        margin: 6px 0;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      li:hover {
        background-color: #ffebd1;
      }

      #clickHint {
        font-size: 12px;
        color: #777;
      }

      .buttons-container {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      @media (max-width: 800px) {
        .container {
          flex-direction: column;
          gap: 40px;
        }

        .history-container, .lottery-container, .settings-container {
          flex: none;
          width: 100%;
        }
      }

      #prev-settings-title, #clickHint, #lottery-price, #draw-history-title, #clearSettingHistoryBtn, #lottery-title {
        margin-bottom: -3px; /* 減少間距 */
      }
  </style>
</head>

<body>
  <h1 id="lottery-title"></h1>
  <div class="container">
    <!-- 抽籤紀錄區塊 -->
    <div class="history-container">
      <h2 id="draw-history-title"></h2>
      <button id="clearDrawHistoryBtn"></button>
      <ul id="drawHistory"></ul>
    </div>

    <!-- 抽獎輪盤區塊 -->
    <div class="lottery-container">
      <div class="lottery-box" id="displayPrize"></div>
      <button id="toggleBtn" disabled></button>
    </div>

    <!-- 設定獎品區塊 -->
    <div class="settings-container">
      <h2 id="lottery-price"></h2>
      <textarea id="prizeInput" placeholder=""></textarea>
      <div class="buttons-container">
        <button id="setPrizesBtn"></button>
        <button id="clearPrizesBtn"></button>
      </div>

      <h2 id="prev-settings-title"></h2>
      <div id="clickHint"></div>
      <button id="clearSettingHistoryBtn"></button>
      <ul id="prev-settings-list"></ul>
    </div>
  </div>

  <script>
    const wheelTime = 10; // 轉盤轉動時間(秒)

    const messages = {
      "zh-tw": {
        title: "抽籤輪盤",
        setting: "設定",
        placeholder: "請輸入欲抽選的選項，每行一個",
        setPrizeBtn: "確定編輯",
        start: "開始抽籤",
        stop: "停止抽籤",
        ready: "按鈕開始抽籤...",
        alertEmpty: "請輸入至少一個選項！",
        prevSettings: "設定記錄",
        drawHistory: "抽籤記錄",
        clearSetting: "清空設定",
        clearDrawHistory: "清空抽籤記錄",
        clearSettingHistory: "清空設定記錄",
        clickHint: "(點選以載入)"
      },
      "en": {
        title: "Lottery Wheel",
        setting: "Settings",
        placeholder: "Enter options, one per line",
        setPrizeBtn: "Set Prize List",
        start: "Start Lottery",
        stop: "Stop Lottery",
        ready: "Ready to draw...",
        alertEmpty: "Please enter at least one option!",
        prevSettings: "Settings History",
        drawHistory: "Draw History",
        clearSetting: "Clear",
        clearDrawHistory: "Clear Draw History",
        clearSettingHistory: "Clear Setting History",
        clickHint: "(Click to load)"
      }
    };

    function getQueryLang() {
        const params = new URLSearchParams(window.location.search);
        const queryLang = params.get('lang');
        if (queryLang) {
            return queryLang.toLowerCase();
        }
        // fallback to browser language
        return (navigator.language || navigator.languages?.[0] || 'en').toLowerCase();
    }

    // 取得使用語言代碼
    let rawLang = getQueryLang();

    // 語言別名映射
    const langAliasMap = {
    'zh-hant': 'zh-tw',
    'zh-hant-tw': 'zh-tw',
    'zh-hk': 'zh-tw',
    'zh-mo': 'zh-tw',
    // 其他未來可擴充語言：例如 'zh-cn': 'zh-cn', 'ja': 'ja'
    };

    // 將 rawLang 轉換為我們支援的語言代碼
    let lang = langAliasMap[rawLang] || 'en';
    const message = messages[lang] || messages['en'];
    const getMessage = key => typeof message[key] === 'function' ? message[key]() : message[key] || key;

    const prizeInput = document.getElementById('prizeInput');
    const setPrizesBtn = document.getElementById('setPrizesBtn');
    const toggleBtn = document.getElementById('toggleBtn');
    const displayPrize = document.getElementById('displayPrize');
    const prevList = document.getElementById('prev-settings-list');
    const drawHistory = document.getElementById('drawHistory');
    const clearDrawHistoryBtn = document.getElementById('clearDrawHistoryBtn');
    const clearSettingHistoryBtn = document.getElementById('clearSettingHistoryBtn');
    const clearPrizesBtn = document.getElementById('clearPrizesBtn');

    document.getElementById('lottery-title').textContent = getMessage('title');
    document.getElementById('lottery-price').textContent = getMessage('setting');
    document.getElementById('prev-settings-title').textContent = getMessage('prevSettings');
    document.getElementById('draw-history-title').textContent = getMessage('drawHistory');
    document.title = getMessage('title');
    document.getElementById('clearDrawHistoryBtn').textContent = getMessage('clearDrawHistory');
    document.getElementById('clearSettingHistoryBtn').textContent = getMessage('clearSettingHistory');
    document.getElementById('clickHint').textContent = getMessage('clickHint');
    prizeInput.placeholder = getMessage('placeholder');
    setPrizesBtn.textContent = getMessage('setPrizeBtn');
    clearPrizesBtn.textContent = getMessage('clearSetting');
    toggleBtn.textContent = getMessage('start');
    displayPrize.textContent = getMessage('ready');

    let prizes = [];
    let interval = null;
    let spinTimeout = null;
    let prevSettings = [];
    let drawing = false;

    setPrizesBtn.addEventListener('click', () => {
      prizes = prizeInput.value.split('\n').map(item => item.trim()).filter(Boolean);
      if (prizes.length === 0) {
        alert(getMessage("alertEmpty"));
        return;
      }
      displayPrize.textContent = getMessage('ready');
      toggleBtn.disabled = false;
      prevSettings.unshift([...prizes]);
      renderPrevSettings();
      clearPrizesBtn.disabled = false; // 啟用清空按鈕
    });

    clearPrizesBtn.addEventListener('click', () => {
      if (drawing) return; // 如果正在抽籤，則無法清空
      prizeInput.value = ''; // 清空設定框內的選項
      prizes = []; // 清空選項
      displayPrize.textContent = getMessage('ready'); // 顯示 "準備好"
      toggleBtn.disabled = true; // 禁用開始抽籤按鈕
    });

    function renderPrevSettings() {
      prevList.innerHTML = '';
      prevSettings.forEach(set => {
        const li = document.createElement('li');
        li.textContent = set.join(', ');
        li.addEventListener('click', () => {
          if (drawing) return;
          prizes = [...set];
          prizeInput.value = prizes.join('\n');
          displayPrize.textContent = getMessage('ready');
          toggleBtn.disabled = false;
        });
        prevList.appendChild(li);
      });
    }

    toggleBtn.addEventListener('click', () => {
      if (!drawing) {
        if (prizes.length === 0) return;
        drawing = true;
        toggleBtn.textContent = getMessage('stop');
        setPrizesBtn.disabled = true;
        prizeInput.disabled = true;
        clearPrizesBtn.disabled = true;
        prevList.style.pointerEvents = 'none';

        let duration = wheelTime * 1000; // 總轉動時間（毫秒）
        let elapsed = 0;
        let speed = 50; // 初始間隔時間
        let slowdownThreshold = 3000; // 最後幾秒開始變慢
        let slowdownStep = 30; // 每次變慢的程度

        function spin() {
          if (!drawing) return;

          let randomIndex = Math.floor(Math.random() * prizes.length);
          displayPrize.textContent = prizes[randomIndex];

          elapsed += speed;

          // 開始變慢（距離結束小於 slowdownThreshold）
          if (duration - elapsed <= slowdownThreshold) {
            speed += slowdownStep; // 漸漸變慢
          }

          if (elapsed < duration) {
            interval = setTimeout(spin, speed);
          } else {
            stopDraw();
          }
        }

        spin(); // 啟動轉盤
      } else {
        stopDraw();
      }
    });

    function stopDraw() {
      clearTimeout(interval);
      clearTimeout(spinTimeout);
      toggleBtn.textContent = getMessage('start');
      setPrizesBtn.disabled = false;
      prizeInput.disabled = false;
      clearPrizesBtn.disabled = false;
      prevList.style.pointerEvents = 'auto';
      drawing = false;
      drawHistory.insertAdjacentHTML('afterbegin', `<li>${displayPrize.textContent}</li>`);
    }

    clearDrawHistoryBtn.addEventListener('click', () => {
      drawHistory.innerHTML = '';
    });

    clearSettingHistoryBtn.addEventListener('click', () => {
      prevSettings = [];
      renderPrevSettings(); // 重新渲染 UI
    });

  </script>
</body>
</html>
